<template>
  <div class="community-container">
    <!-- 左侧导航条组件 -->
    <SidebarNavigation />
    
    <!-- 主内容区域 -->
    <div class="main-content">
      <div class="nav-container">
        <!-- 顶部自定义导航区域 -->
        <div class="custom-nav">
          <div class="nav-card">
            <h2 class="nav-title">我的导航</h2>
            
            <!-- 用户状态提示 -->
            <div class="user-section">
              <div class="user-info">
                <span class="user-email">HI，{{ userName }}</span>
              </div>
            </div>
            
            <!-- 添加链接按钮 -->
            <div class="add-link-section">
              <button @click="handleAddLinkClick" class="add-link-btn">
                <span class="plus-icon">+</span>
                添加链接
              </button>
            </div>
            
            <!-- 自定义链接卡片 -->
            <div class="custom-links-grid">
              <div 
                v-for="(link, index) in customLinks" 
                :key="index" 
                class="link-card"
                @click="handleCustomLinkClick(link)"
              >
                <div class="link-card-content">
                  <img :src="link.icon || '/default-icon.png'" :alt="link.name" class="link-icon">
                  <div class="link-info">
                    <h3 class="link-name">{{ link.name }}</h3>
                    <p class="link-url">{{ link.url }}</p>
                  </div>
                </div>
                <button @click.stop="removeCustomLink(index)" class="link-delete-btn">×</button>
              </div>
              
              <!-- 空状态提示 -->
              <div v-if="currentUser && customLinks.length === 0" class="empty-state">
                <div class="empty-icon">📋</div>
                <p class="empty-text">还没有添加任何链接</p>
                <p class="empty-subtext">点击上方的"添加链接"按钮开始创建您的个人导航</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 10个类别的导航卡片 -->
        <div class="category-navigation">
          <ProgrammingTools 
            v-for="category in categories" 
            :key="category.title"
            :title="category.title" 
            :icon="category.icon"
            :tools="category.tools"
            @tool-click="handleCategoryToolClick"
          />
        </div>
        
        <!-- 添加链接模态框 -->
        <div v-if="showAddLinkModal" class="modal-overlay" @click="showAddLinkModal = false">
          <div class="modal-content" @click.stop>
            <div class="modal-header">
              <h3>新增链接</h3>
              <button @click="showAddLinkModal = false" class="modal-close-btn">×</button>
            </div>
            
            <div class="modal-body">
              <!-- URL输入区域 -->
              <div class="url-input-section">
                <input 
                  v-model="newLink.url" 
                  placeholder="请输入网站URL" 
                  class="url-input"
                >
                <div class="url-buttons">
                  <button @click="parseWebsite" class="parse-btn">开始解析</button>
                  <button @click="clearParse" class="clear-btn">清空解析</button>
                </div>
              </div>
              
              <!-- 网站图标区域 -->
              <div class="icon-section">
                <div class="icon-preview">
                  <img :src="newLink.icon_url || '@/assets/smile.jpeg'" :alt="newLink.name" class="website-icon">
                  <div class="icon-actions">
                    <input 
                      type="file" 
                      ref="iconInput" 
                      accept="image/*" 
                      @change="handleIconUpload" 
                      style="display: none"
                    >
                    <button @click="$refs.iconInput.click()" class="upload-icon-btn">上传图标</button>
                    <button @click="resetIcon" class="reset-icon-btn">重置图标</button>
                  </div>
                </div>
              </div>
              
              <!-- 网站信息输入区域 -->
              <div class="info-input-section">
                <div class="input-group">
                  <label>网站名称</label>
                  <input 
                    v-model="newLink.name" 
                    placeholder="请输入网站名称" 
                    class="info-input"
                  >
                </div>
                
                <div class="input-group">
                  <label>网站地址</label>
                  <input 
                    v-model="newLink.url" 
                    placeholder="请输入网站地址" 
                    class="info-input"
                    disabled
                  >
                </div>
                
                <div class="input-group">
                  <label>网站描述</label>
                  <textarea 
                    v-model="newLink.description" 
                    placeholder="请输入网站描述" 
                    class="info-textarea"
                    rows="3"
                  ></textarea>
                </div>
              </div>
            </div>
            
            <div class="modal-footer">
              <button @click="showAddLinkModal = false" class="cancel-btn">取消</button>
              <button @click="addCustomLink" class="save-btn">保存</button>
            </div>
          </div>
        </div>
        


      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import SidebarNavigation from '../components/SidebarNavigation.vue'
import ProgrammingTools from '../components/ProgrammingTools.vue'
import { getAllCategories } from '../utils/categoryData'
import { supabase } from '../supabase'
import { useAuthStore } from '../stores/auth.js'

// 模态框显示状态
const showAddLinkModal = ref(false)

// 自定义导航链接
const customLinks = ref([])
const newLink = ref({ 
  name: '', 
  url: '', 
  description: '',
  icon_url: '/default-icon.png'
})

// 10个类别的导航数据
const categories = ref(getAllCategories())

// 使用 Pinia store 获取用户信息
const authStore = useAuthStore()

// 计算属性获取用户昵称
const userName = computed(() => {
  return authStore.user?.displayName || authStore.user?.username || '用户'
})



// 热门推荐标签和应用数据
const tabs = ['全部', '工具', '娱乐', '学习']
const currentTab = ref(0)
const apps = ref([
  { name: 'NBtab-美女动态', desc: '清新无广告，浏览更...', icon: 'https://via.placeholder.com/40', category: '娱乐' },
  { name: '享趣追剧神器', desc: '超高清4K，永久免费...', icon: 'https://via.placeholder.com/40', category: '娱乐' },
  { name: '火车太顺', desc: '火车票抢票助手', icon: 'https://via.placeholder.com/40', category: '工具' },
  { name: '555电影', desc: '免费影视平台', icon: 'https://via.placeholder.com/40', category: '娱乐' },
  { name: 'DeepSeek', desc: '深度求索AI', icon: 'https://via.placeholder.com/40', category: '工具' },
  { name: '豆包', desc: '字节跳动智能助手', icon: 'https://via.placeholder.com/40', category: '工具' },
  { name: '电子木鱼', desc: '赛博功德积累神器', icon: 'https://via.placeholder.com/40', category: '娱乐' },
  { name: 'Excalidraw', desc: '手绘风格流程图工具', icon: 'https://via.placeholder.com/40', category: '工具' },
  { name: '反向词典', desc: '清华大学开源词汇工具', icon: 'https://via.placeholder.com/40', category: '学习' },
])

// 计算属性
const filteredApps = computed(() => {
  if (currentTab.value === 0) return apps.value;
  return apps.value.filter(app => app.category === tabs[currentTab.value]);
})

// 生命周期
onMounted(async () => {
  await authStore.initializeAuth()
  await loadCustomLinks();
})

// 加载用户自定义链接
const loadCustomLinks = async () => {
  const { data, error } = await supabase
    .from('user_custom_links')
    .select('*')
    .order('created_at', { ascending: true })
  
  if (!error && data) {
    customLinks.value = data.map(link => ({
      ...link,
      desc: link.description,
      icon: link.icon_url
    }))
  }
}

// 添加自定义链接
const addCustomLink = async () => {
  if (newLink.value.name && newLink.value.url) {
    // 验证URL格式
    if (!newLink.value.url.startsWith('http://') && !newLink.value.url.startsWith('https://')) {
      newLink.value.url = 'https://' + newLink.value.url;
    }
    
    // 保存到数据库
    const { data, error } = await supabase
      .from('user_custom_links')
      .insert([{
        name: newLink.value.name,
        url: newLink.value.url,
        description: newLink.value.description,
        icon_url: newLink.value.icon_url
      }])
      .select()
    
    if (!error && data) {
      // 添加到本地列表
      const newLinkData = data[0]
      customLinks.value.push({
        ...newLinkData,
        desc: newLinkData.description,
        icon: newLinkData.icon_url
      })
      
      // 重置表单
      newLink.value = { 
        name: '', 
        url: '', 
        description: '',
        icon_url: '/default-icon.png'
      };
      showAddLinkModal.value = false;
    } else {
      alert('保存失败，请重试')
    }
  }
}

// 删除自定义链接
const removeCustomLink = async (index) => {
  const link = customLinks.value[index]
  if (!link.id) {
    customLinks.value.splice(index, 1)
    return
  }
  
  const { error } = await supabase
    .from('user_custom_links')
    .delete()
    .eq('id', link.id)
  
  if (!error) {
    customLinks.value.splice(index, 1)
  } else {
    alert('删除失败，请重试')
  }
}

// 解析网站信息
const parseWebsite = async () => {
  if (!newLink.value.url) {
    alert('请输入网站URL')
    return
  }
  
  try {
    // 验证URL格式
    let url = newLink.value.url
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
      url = 'https://' + url
      newLink.value.url = url
    }
    
    // 获取网站信息
    const domain = new URL(url).hostname
    
    // 使用多个favicon服务，提高成功率
    const faviconServices = [
      `https://www.google.com/s2/favicons?domain=${domain}&sz=64`,
      `https://favicon.im/api/?url=${url}`,
      `https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=${url}&size=64`
    ]
    
    // 设置默认图标
    newLink.value.icon_url = faviconServices[0]
    
    if (!newLink.value.name) {
      // 从URL中提取网站名称
      const nameFromUrl = domain.replace('www.', '').split('.')[0]
      newLink.value.name = nameFromUrl.charAt(0).toUpperCase() + nameFromUrl.slice(1)
    }
    
    if (!newLink.value.description) {
      newLink.value.description = `快速访问 ${domain}`
    }
    
    console.log('网站解析完成:', newLink.value)
    alert('网站信息已自动填充，请检查并修改')
  } catch (error) {
    console.error('解析网站失败:', error)
    alert('解析网站失败，请手动填写信息')
  }
}

// 清空解析结果
const clearParse = () => {
  newLink.value = { 
    name: '', 
    url: newLink.value.url, // 保留URL
    description: '',
    icon_url: '/default-icon.png'
  };
}

// 处理类别工具点击
const handleCategoryToolClick = (tool) => {
  console.log('类别工具被点击:', tool.title)
  if (tool.url && tool.url !== '#') {
    window.open(tool.url, '_blank')
  }
}

// 处理自定义链接点击
const handleCustomLinkClick = (link) => {
  if (link.url) {
    window.open(link.url, '_blank')
  }
}

// 处理添加链接点击
const handleAddLinkClick = () => {
  showAddLinkModal.value = true
}



// 处理图标上传
const handleIconUpload = (event) => {
  const file = event.target.files[0]
  if (file) {
    const reader = new FileReader()
    reader.onload = (e) => {
      newLink.value.icon_url = e.target.result
    }
    reader.readAsDataURL(file)
  }
}

// 重置图标
const resetIcon = () => {
  const domain = newLink.value.url ? new URL(newLink.value.url).hostname : ''
  newLink.value.icon_url = domain ? 
    `https://www.google.com/s2/favicons?domain=${domain}&sz=64` : 
    '/default-icon.png'
}
</script>

<style scoped>
.community-container {
  display: flex;
  min-height: 100vh;
}

.main-content {
  flex: 1;
  margin-left: 60px; /* 与导航栏宽度一致 */
  padding: 20px;
  background-color: #f5f6fa;
  min-height: 100vh;
}

.nav-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.custom-nav {
  margin-bottom: 40px;
}

.nav-card {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.nav-title {
  font-size: 24px;
  margin-bottom: 20px;
  text-align: left; /* 已有左对齐，保留 */
  color: #333;
  font-weight: 600;
  display: flex; /* 新增：让文字与图标在同一行 */
  align-items: center; /* 新增：垂直居中对齐 */
}


.user-section {
  margin-bottom: 16px;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 8px;
}

.user-info {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.user-email {
  font-size: 14px;
  color: #666;
}

.logout-btn {
  padding: 6px 12px;
  background: #ff6b6b;
  color: #fff;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: background-color 0.3s;
}

.logout-btn:hover {
  background: #ff5252;
}

.login-prompt {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.login-prompt span {
  font-size: 14px;
  color: #666;
}

.login-btn {
  padding: 6px 12px;
  background: #007bff;
  color: #fff;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: background-color 0.3s;
}

.login-btn:hover {
  background: #0056b3;
}

.add-link-section {
  margin-bottom: 24px;
}

.add-link-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  background: transparent;
  border: 2px dashed #ddd;
  border-radius: 8px;
  color: #666;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s;
  width: 100%;
  justify-content: center;
}

.add-link-btn:hover {
  border-color: #007bff;
  color: #007bff;
  background: rgba(0, 123, 255, 0.05);
}

.plus-icon {
  font-size: 18px;
  font-weight: bold;
}

.custom-links-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 16px;
}

.link-card {
  display: flex;
  align-items: center;
  background-color: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 5px;
  padding: 8px;
  transition: all 0.3s ease;
  height: 50px;
  overflow: hidden;
  width: calc(16.666% - 6.666px); /* 6列布局 */
  position: relative;
}

.link-card:hover {
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
  transform: translateY(-1px);
}

.link-card-content {
  display: flex;
  align-items: center;
  width: 100%;
  height: 100%;
}

.link-icon {
  width: 45px;
  height: 45px;
  flex-shrink: 0;
  margin-right: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}

.link-info {
  flex-grow: 1;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  overflow: hidden;
}

.link-name {
  font-size: 13px;
  color: #333;
  margin-bottom: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 600;
}

.link-url {
  font-size: 11px;
  color: #666;
  line-height: 1.3;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.link-delete-btn {
  position: absolute;
  top: 4px;
  right: 4px;
  background: #ff6b6b;
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 16px;
  height: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  transition: background-color 0.3s;
  opacity: 0;
  transform: scale(0.8);
}

.link-card:hover .link-delete-btn {
  opacity: 1;
  transform: scale(1);
}

.link-delete-btn:hover {
  background: #ff5252;
}

/* 响应式适配 - 调整列数 */
@media (max-width: 1200px) {
  .link-card {
    width: calc(20% - 6.4px); /* 5列 */
  }
}

@media (max-width: 992px) {
  .link-card {
    width: calc(25% - 6px); /* 4列 */
  }
}

@media (max-width: 768px) {
  .link-card {
    width: calc(33.333% - 5.333px); /* 3列 */
  }
}

@media (max-width: 576px) {
  .link-card {
    width: calc(50% - 4px); /* 2列 */
  }
}

@media (max-width: 400px) {
  .link-card {
    width: 100%; /* 1列 */
  }
}

/* 空状态样式 */
.empty-state {
  grid-column: 1 / -1;
  text-align: center;
  padding: 40px 20px;
  color: #666;
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.empty-text {
  font-size: 16px;
  font-weight: 500;
  margin-bottom: 8px;
}

.empty-subtext {
  font-size: 14px;
  color: #999;
}

/* 模态框样式 */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: #fff;
  border-radius: 12px;
  width: 90%;
  max-width: 480px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid #eee;
}

.modal-header h3 {
  font-size: 16px;
  font-weight: 600;
  color: #333;
  margin: 0;
}

.modal-close-btn {
  background: none;
  border: none;
  font-size: 18px;
  color: #999;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: color 0.3s;
}

.modal-close-btn:hover {
  color: #333;
  background: #f5f5f5;
}

.modal-body {
  padding: 20px;
}

.url-input-section {
  margin-bottom: 16px;
}

.url-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  margin-bottom: 10px;
}

.url-input:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
}

.url-buttons {
  display: flex;
  gap: 10px;
}

.parse-btn, .clear-btn {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #007bff;
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s;
}

.parse-btn {
  background: #007bff;
  color: #fff;
}

.parse-btn:hover {
  background: #0056b3;
  border-color: #0056b3;
}

.clear-btn {
  background: transparent;
  color: #007bff;
}

.clear-btn:hover {
  background: rgba(0, 123, 255, 0.1);
}

.icon-section {
  margin-bottom: 16px;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 6px;
}

.icon-preview {
  display: flex;
  align-items: center;
  gap: 12px;
}

.website-icon {
  width: 40px;
  height: 40px;
  border-radius: 6px;
  object-fit: cover;
  border: 1px solid #ddd;
}

.icon-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.upload-icon-btn, .reset-icon-btn {
  padding: 6px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  background: #fff;
  color: #666;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s;
  white-space: nowrap;
}

.upload-icon-btn:hover {
  border-color: #007bff;
  color: #007bff;
}

.reset-icon-btn:hover {
  border-color: #ff6b6b;
  color: #ff6b6b;
}

.info-input-section {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.input-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.input-group label {
  font-size: 13px;
  font-weight: 500;
  color: #333;
}

.info-input, .info-textarea {
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  transition: border-color 0.3s;
}

.info-input:focus, .info-textarea:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
}

.info-textarea {
  resize: vertical;
  min-height: 60px;
  max-height: 80px;
}

.modal-footer {
  display: flex;
  gap: 10px;
  padding: 16px 20px;
  border-top: 1px solid #eee;
  justify-content: flex-end;
}

.cancel-btn, .save-btn {
  padding: 8px 16px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s;
}

.cancel-btn {
  background: #fff;
  color: #666;
}

.cancel-btn:hover {
  background: #f5f5f5;
  border-color: #999;
}

.save-btn {
  background: #007bff;
  color: #fff;
  border-color: #007bff;
}

.save-btn:hover {
  background: #0056b3;
  border-color: #0056b3;
}

.hot-recommendation {
  margin-top: 40px;
}

.section-title {
  font-size: 24px;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  color: #333;
}

.section-title::before {
  content: '';
  display: inline-block;
  width: 20px;
  height: 20px;
  background: url('https://via.placeholder.com/20/ff5722') no-repeat center;
  margin-right: 8px;
}

.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  align-items: center;
}

.tabs button {
  padding: 8px 15px;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: #fff;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
}

.tabs button:hover {
  background: #f8f9fa;
}

.tabs button.active {
  background: #007bff;
  color: #fff;
  border-color: #007bff;
}

.rank-btn {
  margin-left: auto;
  background: #ff9800;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 8px 15px;
  cursor: pointer;
  font-size: 14px;
  transition: background-color 0.3s;
}

.rank-btn:hover {
  background: #f57c00;
}

.app-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 20px;
}

.app-card {
  border: 1px solid #eee;
  border-radius: 8px;
  padding: 15px;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  transition: all 0.3s;
  background: #fff;
  cursor: pointer;
}

.app-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  border-color: #007bff;
}

.app-icon {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  margin-bottom: 10px;
  object-fit: cover;
}

.app-name {
  font-size: 16px;
  margin-bottom: 5px;
  color: #333;
  font-weight: 600;
}

.app-desc {
  font-size: 14px;
  color: #666;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  width: 100%;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .main-content {
    margin-left: 0;
    padding: 10px;
  }
  
  .nav-container {
    padding: 10px;
  }
  
  .link-input {
    flex-direction: column;
  }
  
  .app-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
  }
  
  .tabs {
    flex-wrap: wrap;
  }
  
  .rank-btn {
    margin-left: 0;
    margin-top: 10px;
  }
}

/* 类别导航区域样式 */
.category-navigation {
  display: flex;
  flex-direction: column;
  gap: 20px;
  margin-top: 20px;
}

/* 确保类别导航与顶部我的导航左对齐 */
.category-navigation .programming-tools-container {
  margin: 0; /* 移除自动居中 */
  width: 100%; /* 占满容器宽度 */
}

/* 响应式适配 */
@media (max-width: 768px) {
  .category-navigation {
    gap: 15px;
    margin-top: 15px;
  }
}
</style>